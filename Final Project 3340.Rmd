---
title: "3340 Quiz 4"
author: "Daniel Perry"
date: "11/6/2020"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r}
library(readxl)
FInal_Project_Data_for_R_3340 <- read_excel("C:/Users/Daniel/Downloads/FInal Project Data for R 3340.xlsx")
attach(FInal_Project_Data_for_R_3340)
library(car)
```


```{r}

```


Residual Analysis:

Assessing Normality: To determine whether our residuals fufill the assumption of being normally distributed we generated a "QQ Plot". It appears that data points 32 (New Mexico), and 51 (Wyoming) are severe outliers in this test of normality and should therefore be considered for removal from the data if proved to be influential. Other than that, there is no other obvious departure from normality in this plot.

```{r}
plot(bestmod, which = 2,sub="")
```

After removing 32 (New Mexico) and 51 (Wyoming), we see a more acceptable distribution as the points more accurately approximate a straight line.

```{r}
newdat=FInal_Project_Data_for_R_3340[-c(32,51),]
bestmod2=lm(bestmod,data=newdat)
plot(bestmod2,which = 2,sub="")
```

Assessing Constant Variance: To determine whether our residuals fufill the assumption of having constant variance, we generated a plot of the residuals against the fitted values from the model. Again data points 32 (New mexico) and 51 (Wyoming) raise concern as they are the only severe outliers. Besides that, we see generally equal variance around the mean of zero.

```{r}
plot(bestmod,which=1,sub="")
```


After removing 32 (New Mexico) and 51 (Wyoming), there are still several mild outliers but not nearly as severe. There is no obvious departure from our equal variance assumption here. Thus, we have satisfied this assumption.
```{r}
plot(bestmod2,which = 1,sub="")
```

Plotting Residuals against Regressors: Another check for constant variance. Plotting the residuals against our regressors will provide reassurance for our constant variance assumption that may not have been picked up in our residuals vs fitted values plot. We will also be able to make sure that there is not any type of unwanted relationship between the regressors and our error such as a quadratic or "funnel" pattern. The partial plots contain roughly equal variance and do not suggest there are any serious issues. Potentially influential obsersavtions are repeatedly showing up in our tests and will be assessed and considered for removal in the following section of our analysis.

```{r}
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_No_One_Allowed_Smoking_at_Home,xlab = "Residuals", ylab="Percent No One Allowed Smoking at Home")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_Ever_Smoked_100_Cigarettes,xlab="Residuals",ylab="Percent Ever Smoked 100 Cigarettes")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_Workers_in_NonSmoking_Environment,xlab = "Residuals", ylab="Percent Workers in Non=Smoking Environment")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_Obese,xlab="Residuals", ylab="Percent Obese")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_No_Physical_Activity, xlab="Residuals", ylab="Percent no Physical Activity")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_Consumed_More_Than_1Fruit_PerDay, xlab="Residuals", ylab="Percent Consumed > 1 Fruit/Day")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_Consumed_More_Than_1Vegetable_PerDay, xlab="Residuals", ylab="Percent Consumed > 1 Vegetable/Day")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_Below_Poverty, xlab="Residuals",ylab="Percent Below Poverty")
plot(resid(bestmod),FInal_Project_Data_for_R_3340$Percent_At_Least_Grad_Highschool,xlab="Residuals", ylab = "Percent At Least Graduated High School")

```


Examining Leverage Points / Influential Observations: Throughout our Residual Analysis several data points were exposed as severe outliers. We wish to know whether these data points are highly influential and therefore interfering with the accuracy of our model. To do so we will first plot residuals against leverage, and Cook's Distance vs observation. Cook's Distance measures the influence a data point has by measuring its distance from the rest of the data.


```{r}
plot(bestmod,which = 4,sub="", col="red")
plot(bestmod,which = 5,sub="")

```

We can see that data point 29 (Nevada) has a Cook's Distance value of approximately 1 which is considered to be influential. Data points 32 (New Mexico) and 51 (Wyoming) have smaller measures of approximately 0.2.

For more clarity we will generate a Hat Matrix; a matrix that bears diagonal elements that represent the amount of leverage the correpsonding data point in the data set has.


```{r}
#First Column (Intercept Column) of 1s
one=c(rep(1,52))

#matrix 
x=matrix(c(one,Percent_No_One_Allowed_Smoking_at_Home,Percent_Ever_Smoked_100_Cigarettes,Percent_Workers_in_NonSmoking_Environment, Percent_Obese, Percent_No_Physical_Activity, Percent_Consumed_More_Than_1Fruit_PerDay, Percent_Consumed_More_Than_1Vegetable_PerDay, Percent_Below_Poverty, Percent_At_Least_Grad_Highschool),ncol= 10)


help(hat)

hat_matrix=x %*% solve(t(x) %*% x) %*% t(x)

hat_matrix[45,45]

#Looking for hat diagonals greater than 2p/n = 2*9/520
inf_data =c()

for(i in 1:52){
  if(hat_matrix[i,i] > (2*9/52)){
    inf_data=append(inf_data,i)
  }
}

inf_data

print(c(hat_matrix[5,5],hat_matrix[8,8],hat_matrix[12,12],hat_matrix[29,29],hat_matrix[31,31],hat_matrix[45,45]))

```

From these calculations it is clear that data point 29 (Nevada) is a highly influential observations and should therefore be removed from our data. Although there are other observations that did not meet the standard of 2p/n from our hat matrix analysis (2p/n is twice the average size of the diagonal hat matrix values), they were not nearly as extreme as Nevada, and did not show up in previous tests. Initially it was thought that New Mexico and Wyoming were cause for concern, but they too are not extreme enough to be considered for removal.


```{r}
attach(FInal_Project_Data_for_R_3340)

require(MASS)
attach(FInal_Project_Data_for_R_3340)
robbest=rlm(Incidence_Rate ~ Percent_No_One_Allowed_Smoking_at_Home + 
    Percent_Ever_Smoked_100_Cigarettes + Percent_Workers_in_NonSmoking_Environment + 
    Percent_Obese + Percent_No_Physical_Activity + Percent_Consumed_More_Than_1Fruit_PerDay + 
    Percent_Consumed_More_Than_1Vegetable_PerDay + Percent_Below_Poverty + 
    Percent_At_Least_Grad_Highschool)
summary(robbest)
bestmod
bestmod2

pairs(dataframe)

dataframe=data.frame(Incidence_Rate,Percent_No_One_Allowed_Smoking_at_Home, Percent_Ever_Smoked_100_Cigarettes,Percent_Workers_in_NonSmoking_Environment,Percent_Obese,Percent_No_Physical_Activity, Percent_Consumed_More_Than_1Fruit_PerDay,Percent_Consumed_More_Than_1Vegetable_PerDay,Percent_Below_Poverty,Percent_At_Least_Grad_Highschool)

pairs(bestmod)

plot(cor(dataframe))
plot(resid(bestmod),rnorm(52,mean = mean(resid(bestmod)),sd=sd(resid(bestmod))))
install.packages("rlang")
install.packages("car", dependencies = TRUE)
require(car)
vif(cancermodel)
summary(lm(Incidence_Rate ~ Percent_No_One_Allowed_Smoking_at_Home + Percent_Ever_Smoked_100_Cigarettes + Percent_Workers_in_NonSmoking_Environment
                + Percent_Obese + Percent_No_Physical_Activity + Percent_Consumed_More_Than_1Vegetable_PerDay
                + Percent_Below_Poverty))
```



```{r}
sample(FInal_Project_Data_for_R_3340)

```





